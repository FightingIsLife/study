# 分布式系统学习

## 一、分布式系统基础

### 1. 为什么需要分布式系统？
分布式系统通过多台计算机协作解决单机系统无法处理的问题，核心需求包括：

#### 1.1 扩展性（Scalability）
- **垂直扩展瓶颈**：单机硬件（CPU、内存、磁盘）存在物理上限。
- **水平扩展**：通过添加更多机器（节点）提升系统整体能力。

**典型场景**：
- 互联网服务（如淘宝双十一处理海量请求）。
- 大数据计算（如 Hadoop 分布式处理 PB 级数据）。

#### 1.2 高可用性（High Availability）
- **避免单点故障**：单机宕机会导致服务完全不可用。
- **冗余设计**：数据和服务在多个节点备份，部分节点故障时仍可提供服务。

**典型场景**：
- 金融系统（如支付宝多机房容灾）。
- 云计算平台（如 AWS EC2 跨可用区部署）。

#### 1.3 容错性（Fault Tolerance）
- **自动恢复**：节点故障时，系统能自动检测并切换到健康节点。
- **数据持久化**：通过副本机制防止数据丢失。

**典型场景**：
- 分布式数据库（如 Cassandra 自动副本修复）。
- 分布式文件系统（如 HDFS 多副本存储）。

#### 1.4 地理分布（Geographical Distribution）
- **降低延迟**：将服务部署在用户所在区域（如 CDN 加速）。
- **合规性**：数据存储需满足本地法律要求（如 GDPR）。

**典型场景**：
- 视频流媒体（如 Netflix 全球多区域部署）。
- 跨国企业系统（如 Salesforce 多数据中心）。

## 2. 分布式系统的核心挑战
分布式系统的复杂性源于网络和节点不可靠性，主要挑战如下：

### 2.1 网络问题
- **网络延迟（Latency）**：
    - 跨区域通信延迟可能高达数百毫秒（如中美光缆延迟）。
    - **影响**：微服务链式调用可能导致请求总延迟叠加（如 A → B → C）。

- **网络分区（Partition）**：
    - 网络中断导致节点间无法通信（如交换机故障）。
    - **影响**：CAP 理论中的分区容忍性（P）迫使系统在 C 和 A 之间抉择。

### 2.2 节点故障
- **硬件故障**：磁盘损坏、内存错误、电源中断等。
- **软件故障**：程序崩溃、资源泄漏（如线程池耗尽）。
- **慢节点（Slow Node）**：
    - 节点因负载过高或垃圾回收（GC）暂停导致响应变慢。
    - **影响**：可能被其他节点误判为故障（如 ZooKeeper 心跳超时）。

### 2.3 一致性问题
- **强一致性代价**：
    - 需同步所有节点数据，增加延迟（如 Raft 日志复制）。

- **最终一致性问题**：
    - 用户可能读到旧数据（如 DNS 更新传播延迟）。

- **冲突解决**：购物车合并时如何保留用户最新操作？

### 2.4 时钟与顺序
- **物理时钟不同步**：
    - 节点间时钟偏差可能导致事件顺序错乱（如 NTP 同步误差）。

- **逻辑时钟替代方案**：
    - Lamport 时间戳：解决事件因果顺序问题。
    - 向量时钟（Vector Clock）：追踪多节点事件依赖关系。

### 2.5 并发与竞争
- **分布式锁**：
    - 如何实现跨节点的互斥访问（如 Redis RedLock 算法）？
    - **问题**：锁超时与脑裂（如锁持有者宕机但锁未释放）。

- **事务隔离性**：
    - 跨节点事务的隔离级别（如 Spanner 的 TrueTime 实现可串行化）。

### 2.6 运维复杂性
- **部署与升级**：
    - 灰度发布时如何避免版本兼容性问题？

- **监控与调试**：
    - 分布式追踪（如 OpenTelemetry 追踪跨服务请求）。
    - 日志聚合（如 ELK 堆栈收集多节点日志）。

## 3. 总结：挑战与协议的对应关系

| 挑战         | 解决方案（协议/技术）         | 示例                              |
|--------------|-------------------------------|-----------------------------------|
| 网络分区     | CAP 理论、Quorum 机制         | Dynamo 的 NWR 模型                |
| 节点故障     | 心跳检测、Raft 选举          | etcd 的 Leader 选举              |
| 数据一致性   | 2PC、Paxos、CRDTs             | Google Spanner 的全球一致性      |
| 时钟不同步   | 逻辑时钟、TrueTime            | CockroachDB 的 HLC 混合逻辑时钟  |
| 并发控制     | 分布式锁、MVCC                | TiDB 的多版本并发控制            |

## 下一步建议
后续可深入以下方向：
- **协议层**：详细学习 Paxos、Raft、Gossip 等协议。
- **系统设计**：分析 Kafka、ZooKeeper、Cassandra 的架构。
- **实践**：通过实验模拟网络分区和节点故障（如 Chaos Engineering）。

此文档已结构化覆盖分布式系统的核心概念和挑战，后续可根据学习进度逐步补充协议和系统设计的细节。是否需要针对某个部分进一步扩展？